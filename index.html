<!DOCTYPE html>
<html>
<head>
    <title>MediaPipe Object Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision"></script>
</head>
<body>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    
    <!-- 객체 정보 표시 -->
    <p id="objectName">객체: 없음</p>
    <p id="objectCoords">좌표: X=0, Y=0</p>

    <script>
        async function startTracking() {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const objectNameText = document.getElementById("objectName");
            const objectCoordsText = document.getElementById("objectCoords");

            // 카메라 설정
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            // MediaPipe Object Detector 로드
            const { ObjectDetector, FilesetResolver } = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision');
            const visionFileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm");
            const detector = await ObjectDetector.createFromOptions(visionFileset, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/ssd_mobilenet_v2/float32/1/ssd_mobilenet_v2.tflite" },
                scoreThreshold: 0.5
            });

            async function detectObjects() {
                const detections = await detector.detectForVideo(video, performance.now());
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                let foundObject = false;

                detections.forEach(obj => {
                    console.log("감지된 객체:", obj.categoryName); // 어떤 객체가 감지되는지 확인
                    
                    if (obj.categoryName === "cup") { // 컵만 감지
                        foundObject = true;
                        const [x, y, width, height] = obj.boundingBox;
                        ctx.strokeStyle = "red";
                        ctx.lineWidth = 3;
                        ctx.strokeRect(x, y, width, height);

                        let centerX = x + width / 2;
                        let centerY = y + height / 2;

                        // 웹 페이지에 객체 정보 표시
                        objectNameText.innerText = "객체: " + obj.categoryName;
                        objectCoordsText.innerText = `좌표: X=${Math.round(centerX)}, Y=${Math.round(centerY)}`;

                        // 앱인벤터로 좌표 데이터 전송
                        window.AppInventor.setWebViewString(obj.categoryName + "," + Math.round(centerX) + "," + Math.round(centerY));
                    }
                });

                // 컵이 감지되지 않으면 "없음"으로 표시
                if (!foundObject) {
                    objectNameText.innerText = "객체: 없음";
                    objectCoordsText.innerText = "좌표: X=0, Y=0";
                }

                requestAnimationFrame(detectObjects);
            }

            detectObjects();
        }

        startTracking();
    </script>
</body>
</html>
