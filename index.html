<!DOCTYPE html>
<html>
<head>
    <title>MediaPipe Object Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision"></script>
</head>
<body>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    
    <!-- 객체 정보 표시 -->
    <p id="cupInfo">컵: 없음</p>
    <p id="personInfo">사람: 없음</p>

    <script>
        async function startTracking() {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const cupInfo = document.getElementById("cupInfo");
            const personInfo = document.getElementById("personInfo");

            // 카메라 설정
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            // MediaPipe Object Detector 로드
            const { ObjectDetector, FilesetResolver } = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision');
            const visionFileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm");
            const detector = await ObjectDetector.createFromOptions(visionFileset, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/ssd_mobilenet_v2/float32/1/ssd_mobilenet_v2.tflite" },
                scoreThreshold: 0.5
            });

            async function detectObjects() {
                const detections = await detector.detectForVideo(video, performance.now());
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                let foundCup = false;
                let foundPerson = false;
                let cupX = 0, cupY = 0, personX = 0, personY = 0;

                detections.forEach(obj => {
                    console.log("감지된 객체:", obj.categoryName); // 감지된 객체 확인
                    
                    const targetObjects = ["cup", "person"]; // 감지할 객체 목록

                    if (targetObjects.includes(obj.categoryName)) {
                        const [x, y, width, height] = obj.boundingBox;
                        ctx.strokeStyle = (obj.categoryName === "cup") ? "red" : "blue"; // 컵은 빨간색, 사람은 파란색
                        ctx.lineWidth = 3;
                        ctx.strokeRect(x, y, width, height);

                        let centerX = x + width / 2;
                        let centerY = y + height / 2;

                        // 객체별로 데이터 저장
                        if (obj.categoryName === "cup") {
                            foundCup = true;
                            cupX = Math.round(centerX);
                            cupY = Math.round(centerY);
                        } else if (obj.categoryName === "person") {
                            foundPerson = true;
                            personX = Math.round(centerX);
                            personY = Math.round(centerY);
                        }
                    }
                });

                // 웹페이지에 객체 정보 업데이트
                cupInfo.innerText = foundCup ? `컵: X=${cupX}, Y=${cupY}` : "컵: 없음";
                personInfo.innerText = foundPerson ? `사람: X=${personX}, Y=${personY}` : "사람: 없음";

                // 앱인벤터로 데이터 전송
                window.AppInventor.setWebViewString(`cup,${cupX},${cupY};person,${personX},${personY}`);

                requestAnimationFrame(detectObjects);
            }

            detectObjects();
        }

        startTracking();
    </script>
</body>
</html>
